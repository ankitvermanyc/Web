<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Assistant</title>
    <style>
        /* --- CLEAN DARK THEME --- */
        body {
            margin: 0;
            height: 100vh;
            background-color: #121212;
            font-family: 'Segoe UI', sans-serif;
            overflow: hidden;
        }

        /* --- MICROPHONE FLOATING BUTTON (FAB) --- */
        #mic-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: none;
            background: #333; /* Default gray state */
            color: white;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            z-index: 1000;
            outline: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* Hover Effect */
        #mic-btn:hover { transform: scale(1.05); }
        #mic-btn:active { transform: scale(0.95); }

        /* Icons */
        #mic-btn svg { width: 32px; height: 32px; fill: currentColor; }

        /* --- STATE STYLES --- */
        
        /* State 1: Ready (Blue) */
        #mic-btn.ready {
            background: linear-gradient(135deg, #4e8cff, #2a52be);
            box-shadow: 0 4px 20px rgba(78, 140, 255, 0.4);
        }

        /* State 2: Recording (Red Pulse) */
        #mic-btn.recording {
            background: #ff4444;
            animation: pulse-red 1.5s infinite;
        }

        /* State 3: Thinking (Yellow Pulse) */
        #mic-btn.thinking {
            background: #ffbb00;
            animation: pulse-yellow 1.5s infinite;
        }

        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(255, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(255, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 68, 68, 0); }
        }

        @keyframes pulse-yellow {
            0% { box-shadow: 0 0 0 0 rgba(255, 187, 0, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(255, 187, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 187, 0, 0); }
        }

        /* --- SUBTLE STATUS TEXT (Top Center) --- */
        #status-text {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: #666;
            font-size: 0.9rem;
            pointer-events: none;
            transition: opacity 0.3s;
        }
    </style>
</head>
<body>

    <div id="status-text">Tap mic to enable</div>

    <button id="mic-btn" title="Microphone">
        <svg viewBox="0 0 24 24">
            <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>
            <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
        </svg>
    </button>

    <script>
        /* --- CONFIGURATION --- */
        const API_KEY = "AIzaSyDg_-jCXLGrz6laQweUAD9aZCtn61_cK7A";
        const MODEL = "gemini-3-flash-preview";

        /* --- ELEMENTS --- */
        const btn = document.getElementById('mic-btn');
        const status = document.getElementById('status-text');

        let isPermissionGranted = false;
        let mediaRecorder;
        let audioChunks = [];

        /* --- 1. INITIAL CLICK (Permission) --- */
        btn.addEventListener('click', async (e) => {
            // Only run this logic if we don't have permission yet
            if (!isPermissionGranted) {
                status.textContent = "Requesting access...";
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    
                    // Success! Switch to "Ready" mode
                    isPermissionGranted = true;
                    btn.classList.add('ready');
                    status.textContent = "Hold button to speak";
                    
                    // Initialize recorder with this stream
                    setupRecorder(stream);

                } catch (err) {
                    console.error(err);
                    status.textContent = "Access Denied. Reset permissions.";
                    status.style.color = "#ff4444";
                }
            }
        });

        /* --- 2. RECORDER SETUP --- */
        function setupRecorder(stream) {
            mediaRecorder = new MediaRecorder(stream);
            
            mediaRecorder.ondataavailable = (event) => {
                audioChunks.push(event.data);
            };

            mediaRecorder.onstop = async () => {
                // When recording stops, send data
                btn.className = 'thinking'; // Yellow state
                status.textContent = "Gemini is thinking...";
                
                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                const base64 = await blobToBase64(audioBlob);
                await sendToGemini(base64);
            };
        }

        /* --- 3. PUSH-TO-TALK LOGIC --- */
        // START (Mouse/Touch Down)
        const startAction = (e) => {
            if (!isPermissionGranted || !mediaRecorder) return;
            if (mediaRecorder.state === 'recording') return;
            
            e.preventDefault(); // Prevent text selection/ghost clicks
            
            audioChunks = []; // Clear old audio
            mediaRecorder.start();
            
            btn.className = 'recording'; // Red state
            status.textContent = "Listening...";
        };

        // STOP (Mouse/Touch Up)
        const stopAction = (e) => {
            if (!isPermissionGranted || !mediaRecorder) return;
            if (mediaRecorder.state === 'recording') {
                e.preventDefault();
                mediaRecorder.stop(); // This triggers onstop() above
            }
        };

        // Attach Listeners
        btn.addEventListener('mousedown', startAction);
        btn.addEventListener('touchstart', startAction);
        
        btn.addEventListener('mouseup', stopAction);
        btn.addEventListener('mouseleave', stopAction); // If mouse slides off button
        btn.addEventListener('touchend', stopAction);

        /* --- 4. API COMMUNICATION --- */
        async function sendToGemini(base64Audio) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${API_KEY}`;
            
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { text: "You are a helpful voice assistant. Answer briefly in plain text." },
                                { inline_data: { mime_type: "audio/webm", data: base64Audio } }
                            ]
                        }]
                    })
                });

                const data = await response.json();
                
                if (data.error) throw new Error(data.error.message);
                if (!data.candidates) throw new Error("No response.");

                const text = data.candidates[0].content.parts[0].text;
                
                // Speak & Reset
                speak(text);
                status.textContent = "Done";

            } catch (err) {
                console.error(err);
                status.textContent = "Error: " + err.message;
                speak("Sorry, I encountered an error.");
            } finally {
                // Reset button to Blue "Ready" state after a short delay
                setTimeout(() => {
                    btn.className = 'ready';
                    if(status.textContent === "Done") status.textContent = "Hold button to speak";
                }, 1000);
            }
        }

        /* --- 5. UTILITIES --- */
        function blobToBase64(blob) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result.split(',')[1]);
                reader.readAsDataURL(blob);
            });
        }

        function speak(text) {
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            window.speechSynthesis.speak(utterance);
        }
    </script>
</body>
</html>
