<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Website with Gemini Assistant</title>
    <style>
        /* --- 1. GENERAL WEBSITE STYLES --- */
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background-color: #f4f4f9; color: #333; }
        header {
            background-color: #ffffff; height: 70px; display: flex; align-items: center; justify-content: space-between;
            padding: 0 40px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: fixed; top: 0; width: 100%; box-sizing: border-box; z-index: 1000;
        }
        .logo { font-weight: 700; font-size: 1.5rem; color: #2c3e50; }
        .main-content { padding: 120px 40px 40px; max-width: 800px; margin: 0 auto; }
        h1 { font-size: 3rem; margin-bottom: 20px; color: #2c3e50; }
        p { line-height: 1.6; color: #666; font-size: 1.1rem; margin-bottom: 20px; }
        .hero-card { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); }

        /* --- 2. GEMINI WIDGET STYLES --- */
        .gemini-widget { position: relative; display: flex; align-items: center; }

        #gemini-trigger {
            width: 45px; height: 45px; border-radius: 50%; border: none;
            background: linear-gradient(135deg, #4e8cff, #2a52be);
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: transform 0.2s, box-shadow 0.2s; box-shadow: 0 4px 15px rgba(78, 140, 255, 0.3); z-index: 1001;
        }
        #gemini-trigger:hover { transform: scale(1.05); }
        #gemini-trigger:active { transform: scale(0.95); }
        #gemini-trigger svg { width: 24px; height: 24px; fill: white; }

        /* Recording State */
        #gemini-trigger.recording { animation: pulse-red 1.5s infinite; background: linear-gradient(135deg, #ff4e4e, #be2a2a); }
        
        /* Permission Needed State (Pulse Blue) */
        #gemini-trigger.needs-permission { animation: pulse-blue 2s infinite; }

        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(255, 78, 78, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(255, 78, 78, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 78, 78, 0); } }
        @keyframes pulse-blue { 0% { box-shadow: 0 0 0 0 rgba(78, 140, 255, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(78, 140, 255, 0); } 100% { box-shadow: 0 0 0 0 rgba(78, 140, 255, 0); } }

        .gemini-popup {
            position: absolute; top: 60px; right: 0; width: 320px; background: white; border-radius: 12px; padding: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15); border: 1px solid #eee;
            opacity: 0; visibility: hidden; transform: translateY(-10px); transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1); pointer-events: none;
        }
        .gemini-popup.active { opacity: 1; visibility: visible; transform: translateY(0); pointer-events: all; }
        .gemini-popup::before { content: ''; position: absolute; top: -6px; right: 15px; width: 12px; height: 12px; background: white; transform: rotate(45deg); border-left: 1px solid #eee; border-top: 1px solid #eee; }

        .gemini-status { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; color: #999; margin-bottom: 10px; font-weight: 700; }
        .gemini-response { font-size: 0.95rem; color: #333; line-height: 1.5; max-height: 200px; overflow-y: auto; }
        
        .dots span { animation: blink 1.4s infinite both; font-size: 20px; line-height: 10px; }
        .dots span:nth-child(2) { animation-delay: 0.2s; } .dots span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes blink { 0% { opacity: 0.2; } 20% { opacity: 1; } 100% { opacity: 0.2; } }
    </style>
</head>
<body>

    <header>
        <div class="logo">MyCorp Inc.</div>
        <div class="gemini-widget">
            <button id="gemini-trigger" class="needs-permission" title="Click to Enable Mic">
                <svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>
            </button>
            <div class="gemini-popup" id="gemini-popup">
                <div class="gemini-status" id="gemini-status">Setup Required</div>
                <div class="gemini-response" id="gemini-text">Click the microphone icon to allow voice access.</div>
            </div>
        </div>
    </header>

    <div class="main-content">
        <div class="hero-card">
            <h1>Welcome to the Future</h1>
            <p>This demo asks for microphone permission gracefully.</p>
            <p>1. <strong>First Click:</strong> Asks for permission.<br>2. <strong>Then:</strong> Hold to speak.</p>
        </div>
    </div>

    <script>
        // --- CONFIG ---
        const API_KEY = "AIzaSyAehS-QGJqkwKu91wQFLoi2uhT_784gU_0";
        const MODEL_NAME = "gemini-3-flash-preview";

        // --- ELEMENTS ---
        const triggerBtn = document.getElementById('gemini-trigger');
        const popup = document.getElementById('gemini-popup');
        const statusEl = document.getElementById('gemini-status');
        const textEl = document.getElementById('gemini-text');

        let mediaRecorder;
        let audioChunks = [];
        let globalStream = null; // Store the stream globally
        let isPermissionGranted = false;

        // --- 1. PERMISSION HANDLING ---
        
        async function requestMicrophone() {
            try {
                // Open popup to show we are trying
                popup.classList.add('active');
                statusEl.textContent = "Requesting Access...";
                textEl.textContent = "Please click 'Allow' in your browser pop-up.";

                // The browser prompt happens here
                globalStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                // Success
                isPermissionGranted = true;
                triggerBtn.classList.remove('needs-permission'); // Stop pulsing blue
                triggerBtn.title = "Hold to Speak";
                statusEl.textContent = "Ready";
                statusEl.style.color = "#4e8cff";
                textEl.textContent = "Microphone connected! Now, click and HOLD the button to speak.";

            } catch (err) {
                console.error("Permission denied:", err);
                statusEl.textContent = "Error";
                statusEl.style.color = "#ff4e4e";
                textEl.textContent = "Microphone permission was denied. Please reset permissions in your browser settings.";
            }
        }

        // --- 2. RECORDING LOGIC ---

        function startRecording() {
            // Safety check: if no permission, do nothing (wait for click event to handle it)
            if (!isPermissionGranted || !globalStream) return;

            popup.classList.add('active');
            
            let options = { mimeType: 'audio/webm' };
            if (!MediaRecorder.isTypeSupported('audio/webm')) {
                options.mimeType = MediaRecorder.isTypeSupported('audio/mp4') ? 'audio/mp4' : '';
            }

            // Reuse the global stream
            mediaRecorder = new MediaRecorder(globalStream, options);
            audioChunks = [];

            mediaRecorder.ondataavailable = e => { if (e.data.size > 0) audioChunks.push(e.data); };
            mediaRecorder.onstop = processAudio; // Trigger Gemini when stopped

            mediaRecorder.start();
            
            // UI Updates
            triggerBtn.classList.add('recording');
            statusEl.textContent = "Listening...";
            statusEl.style.color = "#ff4e4e";
            textEl.innerHTML = '<div class="dots"><span>.</span><span>.</span><span>.</span></div>';
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                triggerBtn.classList.remove('recording');
                statusEl.textContent = "Thinking...";
                statusEl.style.color = "#4e8cff";
            }
        }

        // --- 3. GEMINI API ---

        async function processAudio() {
            // Note: In the 'onstop' event, audioChunks is ready
            const audioBlob = new Blob(audioChunks, { type: mediaRecorder.mimeType });
            const base64Audio = await blobToBase64(audioBlob);

            const url = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${API_KEY}`;
            
            const payload = {
                contents: [{
                    parts: [
                        { text: "You are a helpful assistant. Be concise." },
                        { inline_data: { mime_type: mediaRecorder.mimeType, data: base64Audio } }
                    ]
                }]
            };

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();
                if (!response.ok) throw new Error(data.error?.message || "API Error");

                const aiText = data.candidates[0].content.parts[0].text;
                
                statusEl.textContent = "Gemini:";
                statusEl.style.color = "#888";
                typeWriterEffect(aiText);
                speakText(aiText);

            } catch (error) {
                statusEl.textContent = "Error";
                textEl.textContent = error.message;
            }
        }
